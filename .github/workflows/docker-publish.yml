name: 一键发布 Docker 镜像

# 触发方式：
# 1. 手动触发 (workflow_dispatch) - 也就是网页上的"Run workflow"按钮
# 2. 代码推送到 main 分支时自动触发 (可选，不需要可删除 push 部分)
on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    # 授予权限以便推送到 Packages
    permissions:
      contents: read
      packages: write

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 QEMU (支持多架构)
        uses: docker/setup-qemu-action@v3

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录到 GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 提取元数据
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          # 这里配置强制生成 latest 标签
          tags: |
            type=raw,value=latest
            type=sha,format=long

      - name: 构建并推送
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # 自动生成 latest 和 sha 标签
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # 同时构建 PC版(amd64) 和 手机/Mac版(arm64)
          platforms: linux/amd64,linux/arm64
